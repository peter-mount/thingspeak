<!DOCTYPE html>
<html style="height: 100%;">
  <head>
    <script type="text/javascript" src="../../assets/javascripts/jquery.min.js"></script>
    <script type="text/javascript" src="../../assets/javascripts/highcharts-3.0.8.js"></script>
    <script type="text/javascript" src="../../assets/javascripts/exporting.js"></script>
    <script src="../../assets/javascripts/raphael-2.1.4.min.js"></script>
    <script src="../../assets/javascripts/justgage-1.1.0.min.js"></script>
    <script src="../../assets/javascripts/gauge.min.js"></script>
    <script>
        $(document).on('page:load ready', function(){
            var chartOptions = {
              chart: {
                renderTo: 'chart-container',
                defaultSeriesType: '<%= params[:type] ? "#{params[:type]}" : "line" %>',
                backgroundColor: '<%= params[:bgcolor] || "#ffffff" %>',
                events: {
                  load: function() {
                    //if dynamic and no "timeslice" options are set
                    //   GAK 02/16/2013 Let's try to add the last "average" slice if params[:average]

                    var url = '<%= "#{@domain}channels/#{params[:channel_id]}/feed/last.json?callback=?&offset=0&location=true#{@qs}" %>' ;
                    if ("<%= params[:average] %>".length > 0) {
                      url = '<%= "#{@domain}channels/#{params[:channel_id]}/feed/last_average.json?callback=?&offset=0&location=true&average=#{params[:average]}#{@qs}" %>' ;
                    } else if ("<%= params[:median] %>".length > 0) {
                      url = '<%= "#{@domain}channels/#{params[:channel_id]}/feed/last_median.json?callback=?&offset=0&location=true&median=#{params[:median]}#{@qs}" %>' ;
                    } else if ("<%= params[:sum] %>".length > 0) {
                      url = '<%= "#{@domain}channels/#{params[:channel_id]}/feed/last_sum.json?callback=?&offset=0&location=true&sum=#{params[:sum]}#{@qs}" %>' ;
                    }

                    if ('true' === '<%= params[:dynamic] %>' && ('<%= params[:timescale] %>'.length < 1)) {
                      // push data every 15 seconds
                      setInterval(function() {
                        // get the data with a webservice call if we're just getting the last channel
                        $.getJSON(url, function(data) {
                          // if data exists
                          if (data && data.field<%= params[:id] %>) {

                            var p = new Highcharts.Point();
                            // set the proper values
                            var v = data.field<%= params[:id] %>;

                            p.x = getChartDate(data.created_at);
                            p.y = parseFloat(v);
                            // add location if possible
                            if (data.location) { p.name = data.location; }
                            // get the last date if possible
                            if (dynamicChart.series[0].data.length > 0) {
                              last_date = dynamicChart.series[0].data[dynamicChart.series[0].data.length-1].x;
                            }
                            var shift = <%= (@push=='true') ? 'true' : 'false' %> ; //default for shift

                            //if push is requested in parameters
                            // then if results is and data.length is < results, shift = false
                            var results = <%= (@results) ? @results : 60 %>;

                            if ( results  && dynamicChart.series[0].data.length+1 >= results )   {
                              shift = true ;
                            }
                            // if a numerical value exists and it is a new date, add it
                            if (!isNaN(parseInt(v)) && (p.x != last_date)<% if params[:max].present? && Feed.numeric?(params[:max]) %> && p.y <= <%= params[:max] %><% end %><% if params[:min].present? && Feed.numeric?(params[:min]) %> && p.y >= <%= params[:min] %><% end %>) {
                              dynamicChart.series[0].addPoint(p, true, shift);
                            }
                            else {
                              dynamicChart.series[0].data[dynamicChart.series[0].data.length-1].update(p);
                            }

                            // add my metric code here.
                        }
                      });

                  }, 15000);
              }
            }
              }
          },
          title: {
              text: ''
          },
          plotOptions: {
            line: {
              color: '<%= params[:color] || "#d62020" %>'
            },
            bar: {
              color: '<%= params[:color] || "#d62020" %>'
            },
            column: {
              color: '<%= params[:color] || "#d62020" %>'
            },
            spline: {
              color: '<%= params[:color] || "#d62020" %>'
            },
            series: {
              marker: {
                radius: 3
              },
              animation: true,
              step: <%= params[:step] || 'false' %>,
              borderWidth: 0,
              turboThreshold: 0
            }
          },
          tooltip: {
              // reformat the tooltips so that local times are displayed
              formatter: function() {
            var d = new Date(this.x + (myOffset*60000));
            var n = (this.point.name === undefined) ? '' : '<br/>' + this.point.name;
            return this.series.name + ':<b>' + this.y + '</b>' + n + '<br/>' + d.toDateString() + '<br/>' + d.toTimeString().replace(/\(.*\)/, "");
              }
          },
          xAxis: {
              type: 'datetime',
              title: {
            text: 'test'
              }
          },
          yAxis: {
            title: {
              text: ''
            },
            min: <%= params[:yaxismin].present? ? params[:yaxismin] : 'null '%>,
            max: <%= params[:yaxismax].present? ? params[:yaxismax] : 'null' %>
          },
          exporting: {
              enabled: <%= (params[:export].present? && params[:export] == 'true') ? 'true' : 'false' %>
          },
          legend: {
              enabled: false
          },
          series: [
            { name: data.channel.field<%= params[:id] %> }
          ],
          credits: {
              text: '易智云仪表',
              href: 'http://101.6.215.9/',
              style: { color: '#D62020' }
          }
        };

            // add the data to the chart
            chartOptions.series[0].data = chartData;

            // set chart labels here so that decoding occurs properly
            chartOptions.title.text = <% if params[:title] %>decodeURIComponent('<%= u(params[:title]) %>')<% else %>data.channel.name<% end %>;
            chartOptions.xAxis.title.text = <% if params[:xaxis] %>decodeURIComponent('<%= u(params[:xaxis]) %>')<% else %>'Date'<% end %>;
            chartOptions.yAxis.title.text = <% if params[:yaxis] %>decodeURIComponent('<%= u(params[:yaxis]) %>')<% else %><%= "data.channel.field#{params[:id]}" %><% end %>;

            // draw the chart
            var dynamicChart = new Highcharts.Chart(chartOptions);
              
        });
    </script>

    <%= javascript_include_tag 'application' %>

</head>
<body style='background-color: <%= params[:bgcolor] ? params[:bgcolor] : 'white' %>; height: 100%; margin: 0; padding: 0;'>
  <div id="chart-container" style="<%= @width_style %> <%= @height_style %> display: block; position:absolute; bottom:0; top:0; left:0; right:0; margin: 5px 15px 15px 0; overflow: hidden;">
    <canvas id="foo"></canvas>
    <%= image_tag 'ajax-loader.gif', :style => "position: absolute; margin: auto; top: 0; left: 0; right: 0; bottom: 0;" %>
  </div>
</body>
</html>